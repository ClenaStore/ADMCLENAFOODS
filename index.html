<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel ‚Ä¢ Clena Foods</title>
  <meta name="color-scheme" content="dark light">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0e0f12; --panel:#14161a; --line:#262b36; --txt:#f7f8fa; --muted:#cbd5e1;
      --brand:#e63946; --brand2:#ff8f1f; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0f1115,#0b0c10);color:var(--txt);font-family:Inter,system-ui,Arial}
    header{position:sticky;top:0;z-index:10;padding:12px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,rgba(20,22,26,.95),rgba(20,22,26,.75));backdrop-filter:blur(8px)}
    .wrap{max-width:1100px;margin:0 auto;padding:0 12px}
    .title{display:flex;align-items:center;gap:12px}
    .title img{width:34px;height:34px;border-radius:8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    input, select, button, textarea{
      background:#0f1115;border:1px solid var(--line);color:var(--txt);border-radius:10px;padding:10px 12px;font:inherit
    }
    button{cursor:pointer;background:linear-gradient(180deg,#f97316,#ea580c);font-weight:800;border:0}
    button.secondary{background:linear-gradient(180deg,#1a1f27,#14181f);border:1px solid var(--line);font-weight:600}
    button.ghost{background:transparent;border:1px dashed var(--line);color:var(--muted)}
    main{max-width:1100px;margin:16px auto;padding:0 12px;display:grid;gap:12px}
    .card{background:linear-gradient(180deg,#171a20,#14161b);border:1px solid var(--line);border-radius:14px;padding:12px}
    .tabs{display:flex;gap:8px}
    .tabs button{flex:1}
    .hidden{display:none!important}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px dashed #2a2f3b;padding:8px;text-align:left;font-size:14px}
    th{font-weight:800;color:#e5e7eb}
    td small{color:var(--muted)}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0f1115;border:1px solid var(--line);
      border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .space{flex:1}
    .status-dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .grid,.charts{grid-template-columns:1fr} th:nth-child(3),td:nth-child(3){display:none} }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <img src="https://github.com/ClenaStore/foods/blob/main/paste/ChatGPT%20Image%2027%20de%20ago.%20de%202025,%2019_35_02.png?raw=true" alt="">
        <div>
          <div style="font-weight:800">Clena Foods ‚Äî Painel</div>
          <div style="font-size:12px;color:var(--muted)">Controle de pedidos, pagamentos e relat√≥rios</div>
        </div>
      </div>

      <!-- Conex√£o -->
      <div class="toolbar">
        <input id="apiUrl" placeholder="API URL (Apps Script Web App)" style="min-width:360px;flex:1">
        <input id="adminSecret" placeholder="Admin secret" type="password" style="width:220px">
        <button id="btnSaveConn">Salvar conex√£o</button>
        <button class="secondary" id="btnReload">Recarregar</button>
        <span id="connState" class="pill">‚è≥ N√£o conectado</span>
      </div>

      <!-- Tabs -->
      <div class="toolbar">
        <div class="tabs" style="flex:1">
          <button class="secondary" data-tab="pedidos">Pedidos</button>
          <button class="secondary" data-tab="relatorios">Relat√≥rios</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- PEDIDOS -->
    <section id="tab-pedidos" class="card">
      <div class="row">
        <strong>Pedidos</strong><span class="pill" id="ordersCount">‚Äî</span>
        <div class="space"></div>
        <input id="fSearch" placeholder="Buscar (ID, cliente, WhatsApp)">
        <select id="fStatus">
          <option value="">Status (todos)</option>
          <option>Recebido</option>
          <option>Em preparo</option>
          <option>Pronto</option>
          <option>Saiu para entrega</option>
          <option>Conclu√≠do</option>
          <option>Cancelado</option>
        </select>
        <select id="fPay">
          <option value="">Pagamento (todos)</option>
          <option value="pix">PIX</option>
          <option value="credito">Cr√©dito</option>
          <option value="debito">D√©bito</option>
          <option value="dinheiro">Dinheiro</option>
        </select>
        <input id="fDateFrom" type="date" title="De">
        <input id="fDateTo" type="date" title="At√©">
        <button class="secondary" id="btnFiltrar">Filtrar</button>
      </div>

      <div style="overflow:auto;margin-top:8px">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>Pedido</th>
              <th>Cliente</th>
              <th>Entrega / Endere√ßo</th>
              <th>Pagamento</th>
              <th>Status</th>
              <th>Total</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
            <tr><td colspan="7" style="text-align:center;color:var(--muted)">Carregando‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- RELAT√ìRIOS -->
    <section id="tab-relatorios" class="card hidden">
      <div class="row">
        <strong>Relat√≥rios</strong>
        <div class="space"></div>
        <input id="rDateFrom" type="date" title="De">
        <input id="rDateTo" type="date" title="At√©">
        <button class="secondary" id="btnRunReports">Atualizar</button>
      </div>

      <div class="charts" style="margin-top:10px">
        <div class="card" style="min-height:360px">
          <strong>Formas de pagamento</strong>
          <canvas id="chartPay" height="280"></canvas>
        </div>
        <div class="card" style="min-height:360px">
          <strong>Produtos mais vendidos (Top 10)</strong>
          <canvas id="chartTop" height="280"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Vendas por dia</strong>
        <canvas id="chartDays" height="280"></canvas>
      </div>
    </section>
  </main>

  <script>
  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const store = {
    get(k,def){ try{return JSON.parse(localStorage.getItem(k)) ?? def}catch{return def} },
    set(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
  };
  const BRL = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const fmtDT = s => { const d=new Date(s); if(!s||isNaN(d)) return '-'; return d.toLocaleString('pt-BR'); };

  let API_URL = store.get('adm_api','https://script.google.com/macros/s/AKfycbxjGPNBX27DtQzIziM-tlsjVzxOt9bV9RP4TDgZWEIhJVnoowTtfIxlWepYedltBbVy/exec');
  let ADMIN_SECRET = store.get('adm_secret','');

  // UI init
  $('#apiUrl').value = API_URL;
  $('#adminSecret').value = ADMIN_SECRET || '';

  // Tabs
  $$('.tabs [data-tab]').forEach(b=>{
    b.onclick = ()=>{
      $$('.tabs [data-tab]').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const t = b.dataset.tab;
      $('#tab-pedidos').classList.toggle('hidden', t!=='pedidos');
      $('#tab-relatorios').classList.toggle('hidden', t!=='relatorios');
    };
  });
  // default
  document.querySelector('[data-tab="pedidos"]').click();

  // Conn
  $('#btnSaveConn').onclick = ()=>{
    API_URL = $('#apiUrl').value.trim();
    ADMIN_SECRET = $('#adminSecret').value.trim();
    store.set('adm_api', API_URL);
    store.set('adm_secret', ADMIN_SECRET);
    setConnState('üîó Conectado (salvo)');
  };
  $('#btnReload').onclick = ()=> { loadOrders(); runReports(); };

  function setConnState(txt, cls=''){ const el=$('#connState'); el.textContent=txt; el.className='pill '+cls; }

  // ===== API helpers =====
  async function api(acao, payload={}){
    if(!API_URL){ setConnState('‚ùå Sem API URL','bad'); throw new Error('Defina a API URL'); }
    const body = { acao, admin_secret: ADMIN_SECRET, ...payload };
    const res = await fetch(API_URL, { method:'POST', body: JSON.stringify(body) });
    const text = await res.text();
    let data; try{ data = JSON.parse(text) }catch(e){ throw new Error('Resposta n√£o-JSON: '+text.slice(0,200)); }
    if(!res.ok || data.ok===false) throw new Error(data.error||('HTTP '+res.status));
    return data;
  }

  // ===== PEDIDOS =====
  let ALL_ORDERS = [];
  async function loadOrders(){
    try{
      setConnState('‚è≥ Carregando pedidos‚Ä¶'); 
      $('#ordersBody').innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted)">Carregando‚Ä¶</td></tr>`;
      const data = await api('adminListOrders');
      ALL_ORDERS = data.items||[];
      renderOrders();
      setConnState('‚úÖ OK','ok');
    }catch(e){
      console.error(e);
      setConnState('‚ùå Erro: '+e.message,'bad');
      $('#ordersBody').innerHTML = `<tr><td colspan="7" style="text-align:center;color:#ef4444">Erro ao carregar: ${e.message}</td></tr>`;
    }
  }

  function filterOrders(){
    const q = ($('#fSearch').value||'').toLowerCase();
    const st = $('#fStatus').value;
    const pay = $('#fPay').value;
    const d1 = $('#fDateFrom').value ? new Date($('#fDateFrom').value+'T00:00:00') : null;
    const d2 = $('#fDateTo').value ? new Date($('#fDateTo').value+'T23:59:59') : null;

    return (ALL_ORDERS||[]).filter(o=>{
      if(st && (o.status_pedido||'') !== st) return false;
      if(pay && (o.pay||'') !== pay) return false;
      if(d1 && new Date(o.created_at) < d1) return false;
      if(d2 && new Date(o.created_at) > d2) return false;

      if(q){
        const hay = [
          o.id, o.user?.nome, o.user?.whatsapp, o.endereco?.bairro, o.endereco?.rua
        ].filter(Boolean).join(' ').toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });
  }

  function renderOrders(){
    const items = filterOrders();
    $('#ordersCount').textContent = items.length+' / '+(ALL_ORDERS||[]).length;

    if(!items.length){
      $('#ordersBody').innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted)">Sem dados</td></tr>`;
      return;
    }

    const payLabel = v => ({pix:'PIX', credito:'Cr√©dito', debito:'D√©bito', dinheiro:'Dinheiro'})[v] || (v||'‚Äî');
    const entrLabel = v => v==='pickup'?'Retirada':(v==='delivery'?'Entrega':'‚Äî');

    const rows = items.map(o=>{
      const bairroInfo = (o.entrega==='delivery' && o.endereco?.bairro) ? ` ‚Ä¢ ${o.endereco.bairro}` : '';
      return `
      <tr data-id="${o.id}">
        <td>
          <div style="font-weight:800">${o.id}</div>
          <small>${fmtDT(o.created_at)}</small>
        </td>
        <td>
          <div>${o.user?.nome||'-'}</div>
          <small>${o.user?.whatsapp||''}</small>
        </td>
        <td>
          <div>${entrLabel(o.entrega)}${bairroInfo}</div>
          <small>${o.endereco?.rua? (o.endereco.rua+', '+(o.endereco.num||'')) : ''}</small>
        </td>
        <td>
          <select class="selPay">
            <option value="">‚Äî</option>
            <option value="pix" ${o.pay==='pix'?'selected':''}>PIX</option>
            <option value="credito" ${o.pay==='credito'?'selected':''}>Cr√©dito</option>
            <option value="debito" ${o.pay==='debito'?'selected':''}>D√©bito</option>
            <option value="dinheiro" ${o.pay==='dinheiro'?'selected':''}>Dinheiro</option>
          </select>
          <div style="margin-top:6px">
            <select class="selPayStatus">
              <option ${o.status_pagamento==='Pendente'?'selected':''}>Pendente</option>
              <option ${o.status_pagamento==='Aprovado'?'selected':''}>Aprovado</option>
              <option ${o.status_pagamento==='Recusado'?'selected':''}>Recusado</option>
              <option ${o.status_pagamento==='Estornado'?'selected':''}>Estornado</option>
            </select>
          </div>
        </td>
        <td>
          <select class="selOrderStatus">
            ${['Recebido','Em preparo','Pronto','Saiu para entrega','Conclu√≠do','Cancelado'].map(s=>`<option ${o.status_pedido===s?'selected':''}>${s}</option>`).join('')}
          </select>
        </td>
        <td>
          <div style="font-weight:800">${BRL(o.total||0)}</div>
          <small>Frete: ${BRL(o.ship_fee||0)}</small>
        </td>
        <td>
          <div class="row">
            <button class="secondary btnSave">Salvar</button>
            <button class="ghost btnNotify">Notificar</button>
          </div>
        </td>
      </tr>`;
    }).join('');

    $('#ordersBody').innerHTML = rows;

    // wire actions
    $$('#ordersBody .btnSave').forEach(btn=>{
      btn.onclick = async ()=>{
        const tr = btn.closest('tr'); const id = tr.dataset.id;
        const pay = tr.querySelector('.selPay').value;
        const status_pagamento = tr.querySelector('.selPayStatus').value;
        const status_pedido = tr.querySelector('.selOrderStatus').value;

        btn.disabled = true; btn.textContent='Salvando‚Ä¶';
        try{
          await api('adminUpdateOrder', { id, patch: { pay, status_pagamento, status_pedido } });
          toast('‚úÖ Atualizado: '+id);
          // atualiza cache local
          const o = ALL_ORDERS.find(x=>x.id===id);
          if(o){ o.pay=pay; o.status_pagamento=status_pagamento; o.status_pedido=status_pedido; }
        }catch(e){
          toast('‚ùå Erro: '+e.message, true);
        }finally{ btn.disabled=false; btn.textContent='Salvar'; }
      };
    });

    $$('#ordersBody .btnNotify').forEach(btn=>{
      btn.onclick = async ()=>{
        const tr = btn.closest('tr'); const id = tr.dataset.id;
        const o = ALL_ORDERS.find(x=>x.id===id);
        const msg = prompt('Mensagem ao cliente:', `Seu pedido ${id} est√°: ${o?.status_pedido||''}`);
        if(!msg) return;
        btn.disabled=true; btn.textContent='Enviando‚Ä¶';
        try{
          await api('notifyOrder', { order_id:id, user_id:o?.user?.id, title:'Atualiza√ß√£o do pedido', message:msg });
          toast('üì£ Notifica√ß√£o enviada');
        }catch(e){ toast('‚ùå Erro: '+e.message, true); }
        finally{ btn.disabled=false; btn.textContent='Notificar'; }
      }
    });
  }

  $('#btnFiltrar').onclick = renderOrders;
  $('#fSearch').addEventListener('input', ()=>{ clearTimeout(window._fTO); window._fTO=setTimeout(renderOrders,120); });

  // ===== RELAT√ìRIOS =====
  let chPay, chTop, chDays;
  function ensureChart(ctx, type, data, opts){
    if(ctx._chart){ ctx._chart.destroy(); }
    const c = new Chart(ctx, { type, data, options: opts||{} });
    ctx._chart = c; return c;
  }
  async function runReports(){
    try{
      const from = $('#rDateFrom').value || '';
      const to   = $('#rDateTo').value || '';
      const data = await api('adminStats', { date_from: from, date_to: to });

      // Pagamentos (pizza)
      const pay = data.payments || {}; // {pix:10, credito:5, ...}
      const payLabels = ['PIX','Cr√©dito','D√©bito','Dinheiro'];
      const payOrder = ['pix','credito','debito','dinheiro'];
      const payData = payOrder.map(k=> pay[k]||0);
      ensureChart($('#chartPay'), 'doughnut', {
        labels: payLabels,
        datasets: [{ data: payData }]
      }, { plugins:{ legend:{ position:'bottom' }}});

      // Produtos Top (barra)
      const tops = (data.top_products||[]).slice(0,10);
      ensureChart($('#chartTop'), 'bar', {
        labels: tops.map(x=> x.name||x.id),
        datasets: [{ label:'Qtd', data: tops.map(x=> x.qty||0) }]
      }, { scales:{ y:{ beginAtZero:true }}});

      // Vendas por dia (linha)
      const d = data.sales_by_day || []; // [{date:'2025-08-30', total:123.45, count: 7}]
      ensureChart($('#chartDays'), 'line', {
        labels: d.map(x=> x.date),
        datasets: [{ label:'Pedidos', data: d.map(x=> x.count||0), tension:.2 }]
      }, { scales:{ y:{ beginAtZero:true }}});

    }catch(e){
      toast('‚ùå Erro nos relat√≥rios: '+e.message, true);
    }
  }
  $('#btnRunReports').onclick = runReports;

  // ===== Toast =====
  const toast = (t, err=false)=>{
    const div = document.createElement('div');
    div.textContent = t;
    div.style.position='fixed'; div.style.right='12px'; div.style.bottom='12px';
    div.style.background= err? '#7f1d1d' : '#065f46';
    div.style.color='#fff'; div.style.padding='10px 12px'; div.style.borderRadius='10px'; div.style.boxShadow='0 8px 24px rgba(0,0,0,.35)';
    document.body.appendChild(div);
    setTimeout(()=> div.remove(), 2200);
  };

  // Boot
  (function init(){
    if(API_URL){ setConnState('üîó Conectado'); loadOrders(); runReports(); }
  })();
  </script>
</body>
</html>
